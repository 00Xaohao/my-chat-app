<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©åº”ç”¨ç¨‹åº</title>
    <!-- å¼•å…¥ Tailwind CSS ä»¥ä¾¿å¿«é€Ÿç¾åŒ–ç•Œé¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* å¼•å…¥ Inter å­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* è‡ªå®šä¹‰ emoji é¢æ¿çš„æ»šåŠ¨æ¡ */
        .emoji-grid::-webkit-scrollbar {
            width: 8px;
        }

        .emoji-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .emoji-grid::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .emoji-grid::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- è¿™æ˜¯åº”ç”¨ç¨‹åºçš„æ ¹å®¹å™¨ -->
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex">
        <!-- å·¦ä¾§ç”¨æˆ·åˆ—è¡¨ -->
        <div class="w-1/4 bg-gray-50 border-r border-gray-200 p-4 flex flex-col rounded-l-lg">
            <h2 class="text-lg font-bold mb-4 text-center">ç”¨æˆ·åˆ—è¡¨</h2>
            <div id="user-list" class="flex-1 overflow-y-auto space-y-2">
                <!-- ç”¨æˆ·åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                <div id="loading-users" class="text-center text-gray-400">åŠ è½½ç”¨æˆ·ä¸­...</div>
            </div>
        </div>

        <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
        <div class="w-3/4 flex flex-col">
            <!-- èŠå¤©çª—å£å¤´éƒ¨ -->
            <div class="bg-blue-600 text-white p-4 text-center shadow-md rounded-tr-lg flex items-center justify-between">
                <button id="return-button" class="hidden text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    è¿”å›
                </button>
                <h1 id="app-title" class="text-xl font-bold flex-1">å…¬å¼€èŠå¤©</h1>
                <div class="w-16"></div> <!-- å ä½ç¬¦ä»¥ä¿æŒæ ‡é¢˜å±…ä¸­ -->
            </div>

            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-4 relative">
                <!-- æ¶ˆæ¯ä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                <div id="loading-state" class="absolute inset-0 flex items-center justify-center text-gray-500 text-lg">
                    æ­£åœ¨åŠ è½½ä¸­...
                </div>
                <div id="error-state" class="absolute inset-0 flex items-center justify-center text-red-500 text-lg p-4 bg-red-100 rounded-lg hidden">
                    <span id="error-message"></span>
                </div>
            </div>

            <!-- è¾“å…¥å’Œå‘é€åŒºåŸŸ -->
            <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-br-lg relative">
                <!-- è¡¨æƒ…é€‰æ‹©å™¨é¢æ¿ -->
                <div id="emoji-picker" class="absolute bottom-full left-0 mb-2 w-full max-h-64 bg-white rounded-lg shadow-xl p-2 border border-gray-200 hidden overflow-y-auto emoji-grid">
                    <div class="grid grid-cols-8 sm:grid-cols-10 md:grid-cols-12 gap-1">
                        <!-- è¡¨æƒ…ä¼šåœ¨è¿™é‡Œé€šè¿‡ JS åŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>

                <!-- å›å¤é¢„è§ˆæ¡† -->
                <div id="reply-preview" class="p-2 bg-gray-200 rounded-lg mb-2 hidden flex items-center justify-between">
                    <div>
                        <span class="text-xs font-semibold text-gray-700">æ­£åœ¨å›å¤: <span id="reply-to-username"></span></span>
                        <p id="reply-to-text" class="text-sm text-gray-500 truncate"></p>
                    </div>
                    <button id="clear-reply" class="text-gray-500 hover:text-gray-700 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="message-form" class="flex space-x-2 items-center">
                    <input
                        id="message-input"
                        type="text"
                        class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                        placeholder="è¾“å…¥æ¶ˆæ¯..."
                    />
                    <!-- è¡¨æƒ…æŒ‰é’® -->
                    <button
                        id="emoji-button"
                        type="button"
                        class="px-3 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-200 ease-in-out"
                    >
                        ğŸ˜Š
                    </button>
                    <button
                        id="send-button"
                        type="submit"
                        class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-200 ease-in-out"
                    >
                        å‘é€
                    </button>
                    <button
                        id="check-in-button"
                        type="button"
                        class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-200 ease-in-out"
                    >
                        ç­¾åˆ°
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·åè¾“å…¥æ¨¡æ€æ¡† -->
    <div id="username-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h2 class="text-2xl font-bold mb-4 text-center">è¯·è¾“å…¥æ‚¨çš„åå­—</h2>
            <form id="username-form">
                <input 
                    id="username-input" 
                    type="text" 
                    class="w-full p-3 mb-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    placeholder="æ‚¨çš„åå­—..." 
                    required
                />
                <button 
                    type="submit" 
                    class="w-full px-4 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-200"
                >
                    å¼€å§‹èŠå¤©
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, setDoc, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase configuration
            const firebaseConfig = {
              "apiKey": "AIzaSyDdNCBA0XdU6EPRuL68sdL-dkwcjjN0Y_Q",
              "authDomain": "lishi-1321f.firebaseapp.com",
              "projectId": "lishi-1321f",
              "storageBucket": "lishi-1321f.appspot.com",
              "messagingSenderId": "54392732964",
              "appId": "1:54392732964:web:0c702dae6850d1aa1147b1"
            };
            
            // è·å–DOMå…ƒç´ 
            const form = document.getElementById('message-form');
            const input = document.getElementById('message-input');
            const chatBox = document.getElementById('chat-box');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const errorMessageSpan = document.getElementById('error-message');
            const usernameModal = document.getElementById('username-modal');
            const usernameForm = document.getElementById('username-form');
            const usernameInput = document.getElementById('username-input');
            const checkInButton = document.getElementById('check-in-button');
            const userListContainer = document.getElementById('user-list');
            const appTitle = document.getElementById('app-title');
            const returnButton = document.getElementById('return-button');
            const replyPreview = document.getElementById('reply-preview');
            const replyToUsernameSpan = document.getElementById('reply-to-username');
            const replyToTextP = document.getElementById('reply-to-text');
            const clearReplyButton = document.getElementById('clear-reply');
            const emojiButton = document.getElementById('emoji-button');
            const emojiPicker = document.getElementById('emoji-picker');
            const emojiGrid = emojiPicker.querySelector('.grid');


            let db;
            let auth;
            let currentUserId = null;
            let currentUsername = null;
            let currentChatPartnerId = null;
            let unsubscribeFromMessages = null;
            let replyingToMessage = null; // ç”¨äºå­˜å‚¨å›å¤çš„æ¶ˆæ¯

            const privateChatListeners = {}; // å­˜å‚¨ç§èŠç›‘å¬å™¨ä»¥ä¾¿ç®¡ç†
            
            // å¸¸ç”¨ emoji åˆ—è¡¨
            const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰', 'ğŸ‘', 'ğŸ”¥', 'ğŸš€', 'ğŸŒŸ', 'ğŸ¤£', 'ğŸ˜­', 'ğŸ¤”', 'ğŸ™', 'ğŸ’¯', 'ğŸ‘‹', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜‹', 'ğŸ˜œ', 'ğŸ˜‡', 'ğŸ¤«', 'ğŸ˜¬', 'ğŸ¤¯', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ‘‰', 'ğŸ‘ˆ', 'ğŸ‘†', 'ğŸ‘‡', 'ğŸ‘Œ', 'âœŒï¸', 'ğŸ’ª', 'ğŸ™', 'ğŸ¤', 'ğŸ™Œ', 'ğŸ‘€', 'ï¿½', 'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸ’', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¦‰', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ´', 'ğŸ—', 'ğŸº', 'ğŸ¦„', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ', 'ğŸ ', 'ğŸ¬', 'ğŸ³', 'ğŸ¦ˆ', 'ğŸŸ', 'ğŸ™', 'ğŸ¦€', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¡', 'ğŸ¦ ', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ·', 'ğŸŒ¸', 'ğŸŒ¹', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸ', 'ğŸ€', 'ğŸ“', 'ğŸ‡', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦', 'ğŸŒ¶ï¸', 'ğŸŒ½', 'ğŸ¥•', 'ğŸ¥”', 'ğŸ ', 'ğŸ¥', 'ğŸ', 'ğŸ¥–', 'ğŸ¥¨', 'ğŸ§€', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ¥™', 'ğŸ£', 'ğŸ±', 'ğŸœ', 'ğŸ', 'ğŸ›', 'ğŸ²', 'ğŸœ', 'ğŸ¥Ÿ', 'ğŸ¤', 'ğŸ™', 'ğŸš', 'ğŸ˜', 'ğŸ¡', 'ğŸ¢', 'ğŸ§', 'ğŸ¨', 'ğŸ¦', 'ğŸ©', 'ğŸª', 'ğŸ‚', 'ğŸ°', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'â˜•', 'ğŸµ', 'ğŸ¶', 'ğŸ¾', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ¥ƒ', 'ğŸ¥¤', 'ğŸ§Š', 'ğŸ½ï¸', 'ğŸ¥„', 'ğŸ¥¢', 'ğŸ´', 'ğŸ”ª', 'ğŸº', 'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ', 'ğŸ‰', 'ğŸ±', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ¥…', 'â›³', 'ğŸ¯', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¿', 'ğŸ‚', 'ğŸª‚', 'ğŸ§—', 'ğŸšµ', 'ğŸš´', 'ğŸ¤¸', 'â›¹ï¸', 'ğŸ¤º', 'ğŸ‹ï¸', 'ğŸ¤¼', 'ğŸ¤¸', 'ğŸ§˜', 'ğŸš¶', 'ğŸƒ', 'ğŸ§', 'ğŸ§', 'ğŸ•º', 'ğŸ’ƒ', 'ğŸ‘¯', 'ğŸ‘¯â€â™‚ï¸', 'ğŸ•´ï¸', 'ğŸ‘¤', 'ğŸ‘¥'];

            // åŠ¨æ€ç”Ÿæˆ emoji é¢æ¿
            emojis.forEach(emoji => {
                const emojiSpan = document.createElement('span');
                emojiSpan.textContent = emoji;
                emojiSpan.className = 'text-xl cursor-pointer hover:bg-gray-100 rounded-md p-1 transition duration-150';
                emojiSpan.addEventListener('click', () => {
                    input.value += emoji;
                    input.focus();
                    emojiPicker.classList.add('hidden'); // ç‚¹å‡»åéšè—é¢æ¿
                });
                emojiGrid.appendChild(emojiSpan);
            });
            
            // è¡¨æƒ…æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            emojiButton.addEventListener('click', () => {
                emojiPicker.classList.toggle('hidden');
            });

            // è·å–ç”¨æˆ·åçš„é¦–å­—æ¯ï¼ˆæˆ–ç¬¬ä¸€ä¸ªæ±‰å­—ï¼‰
            function getAvatarText(username) {
                return username ? username.charAt(0).toUpperCase() : '?';
            }

            // æ˜¾ç¤ºå›å¤é¢„è§ˆæ¡†
            function showReplyPreview(message) {
                replyingToMessage = { id: message.id, userId: message.userId, username: message.username, text: message.text };
                replyToUsernameSpan.textContent = message.username;
                replyToTextP.textContent = message.text.length > 50 ? message.text.substring(0, 47) + '...' : message.text;
                replyPreview.classList.remove('hidden');
            }

            // æ¸…é™¤å›å¤é¢„è§ˆæ¡†
            function clearReplyPreview() {
                replyingToMessage = null;
                replyPreview.classList.add('hidden');
            }
            
            // ä¸ºæ¸…é™¤å›å¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            clearReplyButton.addEventListener('click', clearReplyPreview);
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUserId = user.uid;
                        const savedUsername = localStorage.getItem('chatUsername');
                        if (savedUsername) {
                            currentUsername = savedUsername;
                            usernameModal.classList.add('hidden');
                            updateUserPresence(currentUserId, currentUsername);
                            
                            // åœ¨ç”¨æˆ·ç™»å½•åç«‹å³è¿è¡Œæ¸…ç†ç¨‹åº
                            cleanupInactiveUsers();

                            enterPublicChat();
                            listenForUsers();
                        } else {
                            usernameModal.classList.remove('hidden');
                        }
                    } else {
                        signInAnonymously(auth).then(() => {
                        }).catch(error => {
                            console.error("Error signing in anonymously: ", error);
                            displayError(`åŒ¿åç™»å½•å¤±è´¥: ${error.message}`);
                        });
                    }
                });

            } catch (error) {
                displayError(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                console.error("Critical error during app initialization: ", error);
            }
            
            usernameForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newUsername = usernameInput.value.trim();
                if (newUsername) {
                    currentUsername = newUsername;
                    localStorage.setItem('chatUsername', currentUsername);
                    usernameModal.classList.add('hidden');
                    updateUserPresence(currentUserId, currentUsername);
                    enterPublicChat();
                    listenForUsers();
                }
            });

            checkInButton.addEventListener('click', async () => {
                const messagesCollection = currentChatPartnerId ? collection(db, 'chats', [currentUserId, currentChatPartnerId].sort().join('_'), 'messages') : collection(db, 'messages');
                
                try {
                    await addDoc(messagesCollection, {
                        type: 'check-in',
                        timestamp: serverTimestamp(),
                        userId: currentUserId,
                        username: currentUsername,
                    });
                    // æ›´æ–°å½“å‰ç”¨æˆ·çš„æ´»è·ƒæ—¶é—´æˆ³
                    updateUserPresence(currentUserId, currentUsername);
                } catch (e) {
                    console.error("Error adding check-in document: ", e);
                    displayError("å‘é€ç­¾åˆ°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚");
                }
            });
            
            returnButton.addEventListener('click', () => {
                enterPublicChat();
            });

            // æ›´æ–°æˆ–è®¾ç½®ç”¨æˆ·çš„å­˜åœ¨å’Œæ´»è·ƒæ—¶é—´æˆ³
            async function updateUserPresence(userId, username) {
                try {
                    const userRef = doc(db, "users", userId);
                    await setDoc(userRef, {
                        username: username,
                        // ä½¿ç”¨æœåŠ¡å™¨æ—¶é—´æˆ³ï¼Œç¡®ä¿æ’åºæ­£ç¡®
                        timestamp: serverTimestamp() 
                    }, { merge: true }); // ä½¿ç”¨ merge:true ç¡®ä¿åªæ›´æ–° timestamp
                } catch (e) {
                    console.error("Error updating user presence: ", e);
                }
            }

            // æ–°å¢çš„è‡ªåŠ¨æ¸…ç†å‡½æ•°
            async function cleanupInactiveUsers() {
                try {
                    const usersCollection = collection(db, 'users');
                    const usersSnapshot = await getDocs(usersCollection);
                    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000); // 1å°æ—¶å‰çš„æ—¶é—´æˆ³
            
                    usersSnapshot.forEach(async (userDoc) => {
                        const userData = userDoc.data();
                        // ç¡®ä¿ timestamp å­˜åœ¨ä¸”æ˜¯æœ‰æ•ˆçš„æ—¶é—´æˆ³
                        if (userData.timestamp && userData.timestamp.toDate() < oneHourAgo) {
                            console.log(`Deleting inactive user: ${userDoc.id}`);
                            await deleteDoc(doc(db, 'users', userDoc.id));
                        }
                    });
                } catch (e) {
                    console.error("Error cleaning up inactive users: ", e);
                }
            }

            // ç›‘å¬ç”¨æˆ·åˆ—è¡¨ï¼Œå¹¶å¤„ç†ç§èŠç‚¹å‡»äº‹ä»¶
            function listenForUsers() {
                // å¢åŠ  orderBy('timestamp', 'desc') ä»¥ç¡®ä¿ç”¨æˆ·åˆ—è¡¨æŒ‰æœ€æ–°æ´»è·ƒæ—¶é—´æ’åº
                const usersCollection = collection(db, 'users');
                const q = query(usersCollection, orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => {
                    userListContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const userId = doc.id;
                        if (userId !== currentUserId) {
                            const userElement = document.createElement('div');
                            const avatarText = getAvatarText(user.username);
                            
                            userElement.id = `user-${userId}`; // ä¸ºæ¯ä¸ªç”¨æˆ·å…ƒç´ æ·»åŠ ä¸€ä¸ªå”¯ä¸€çš„ID
                            userElement.className = 'p-2 rounded-lg hover:bg-gray-200 cursor-pointer transition duration-150 flex items-center space-x-2 relative';
                            userElement.innerHTML = `
                                <div class="w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center bg-gray-300 text-gray-800 font-bold">
                                    ${avatarText}
                                </div>
                                <span>${user.username}</span>
                                <div id="notification-${userId}" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full hidden"></div>
                            `;
                            userElement.addEventListener('click', () => {
                                startPrivateChat(userId, user.username);
                            });
                            userListContainer.appendChild(userElement);

                            // ä¸ºæ¯ä¸ªå…¶ä»–ç”¨æˆ·è®¾ç½®ç§èŠæ¶ˆæ¯ç›‘å¬å™¨
                            setupPrivateChatListener(userId);
                        }
                    });
                    if (snapshot.empty) {
                        userListContainer.innerHTML = '<div class="text-center text-gray-400">ç›®å‰æ²¡æœ‰å…¶ä»–ç”¨æˆ·åœ¨çº¿</div>';
                    }
                });
            }

            // æ–°å¢ï¼šè®¾ç½®ç§èŠæ¶ˆæ¯ç›‘å¬å™¨
            function setupPrivateChatListener(partnerId) {
                // å¦‚æœå·²ç»æœ‰ç›‘å¬å™¨ï¼Œå…ˆå–æ¶ˆ
                if (privateChatListeners[partnerId]) {
                    privateChatListeners[partnerId]();
                }

                const chatDocId = [currentUserId, partnerId].sort().join('_');
                const privateMessagesCollection = collection(db, 'chats', chatDocId, 'messages');
                const q = query(privateMessagesCollection, orderBy('timestamp'));

                // è®¾ç½®æ–°çš„ç›‘å¬å™¨
                privateChatListeners[partnerId] = onSnapshot(q, (querySnapshot) => {
                    const notificationBadge = document.getElementById(`notification-${partnerId}`);
                    if (!querySnapshot.empty && notificationBadge) {
                        const lastMessage = querySnapshot.docs[querySnapshot.docs.length - 1].data();
                        // æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦æ¥è‡ªå¯¹æ–¹ï¼Œå¹¶ä¸”å½“å‰ä¸åœ¨ä¸è¯¥ç”¨æˆ·çš„èŠå¤©ç•Œé¢
                        if (lastMessage.userId !== currentUserId && currentChatPartnerId !== partnerId) {
                            notificationBadge.classList.remove('hidden');
                            // å½“æ”¶åˆ°æ–°ç§ä¿¡æ—¶ï¼Œæ›´æ–°ç§ä¿¡å‘é€è€…çš„æ´»è·ƒæ—¶é—´æˆ³ï¼Œä½¿å…¶æ’åºåˆ°é¡¶éƒ¨
                            updateUserPresence(lastMessage.userId, lastMessage.username);
                        }
                    }
                }, (error) => {
                    console.error(`Error listening to private chat with ${partnerId}: `, error);
                });
            }
            
            function enterPublicChat() {
                if (unsubscribeFromMessages) {
                    unsubscribeFromMessages();
                }
                currentChatPartnerId = null;
                appTitle.textContent = 'å…¬å¼€èŠå¤©';
                returnButton.classList.add('hidden');
                appTitle.classList.add('text-center');
                clearReplyPreview(); // åˆ‡æ¢åˆ°å…¬å¼€èŠå¤©æ—¶æ¸…é™¤å›å¤çŠ¶æ€
                initializeChat(collection(db, 'messages'));
            }

            function startPrivateChat(partnerId, partnerUsername) {
                if (unsubscribeFromMessages) {
                    unsubscribeFromMessages();
                }
                currentChatPartnerId = partnerId;
                appTitle.textContent = partnerUsername;
                returnButton.classList.remove('hidden');
                appTitle.classList.remove('text-center');
                clearReplyPreview(); // åˆ‡æ¢åˆ°ç§èŠæ—¶æ¸…é™¤å›å¤çŠ¶æ€
                
                // æ¸…é™¤ç§èŠé€šçŸ¥
                const notificationBadge = document.getElementById(`notification-${partnerId}`);
                if (notificationBadge) {
                    notificationBadge.classList.add('hidden');
                }

                const chatDocId = [currentUserId, partnerId].sort().join('_');
                const privateMessagesCollection = collection(db, 'chats', chatDocId, 'messages');
                initializeChat(privateMessagesCollection);
            }

            function initializeChat(messagesCollection) {
                // æ¸…ç†å¹¶é‡æ–°ç»‘å®šè¡¨å•æäº¤äº‹ä»¶ï¼Œä»¥ç¡®ä¿å…¶æ­£ç¡®æŒ‡å‘å½“å‰èŠå¤©
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const messageText = input.value.trim();
            
                    if (messageText && currentUserId && currentUsername) {
                        const messageData = {
                            type: 'text',
                            text: messageText,
                            timestamp: serverTimestamp(),
                            userId: currentUserId,
                            username: currentUsername,
                        };

                        // å¦‚æœæ­£åœ¨å›å¤æ¶ˆæ¯ï¼Œæ·»åŠ å›å¤ä¿¡æ¯
                        if (replyingToMessage) {
                            messageData.replyTo = {
                                userId: replyingToMessage.userId,
                                username: replyingToMessage.username,
                                text: replyingToMessage.text
                            };
                        }

                        try {
                            await addDoc(messagesCollection, messageData);
                            input.value = '';
                            clearReplyPreview(); // å‘é€åæ¸…é™¤å›å¤çŠ¶æ€
                            
                            // æ›´æ–°å½“å‰ç”¨æˆ·çš„æ´»è·ƒæ—¶é—´æˆ³
                            updateUserPresence(currentUserId, currentUsername);
                            // å¦‚æœæ˜¯ç§èŠï¼Œä¹Ÿæ›´æ–°èŠå¤©å¯¹è±¡çš„æ´»è·ƒæ—¶é—´æˆ³
                            if (currentChatPartnerId) {
                                updateUserPresence(currentChatPartnerId, appTitle.textContent);
                            }

                        } catch (e) {
                            console.error("Error adding document: ", e);
                            displayError("å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚");
                        }
                    }
                    // å‘é€åéšè— emoji é¢æ¿
                    emojiPicker.classList.add('hidden');
                };

                chatBox.innerHTML = '';
                loadingState.classList.remove('hidden');
            
                const q = query(messagesCollection, orderBy('timestamp'));
                unsubscribeFromMessages = onSnapshot(q, (querySnapshot) => {
                    loadingState.classList.add('hidden');
                    chatBox.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const message = { id: doc.id, ...doc.data() };
                        const isMyMessage = message.userId === currentUserId;
                        const avatarText = getAvatarText(message.username);
                        
                        let messageElement = document.createElement('div');
                        
                        // å¼•ç”¨å›å¤çš„æ¶ˆæ¯æ¸²æŸ“é€»è¾‘
                        let replyHtml = '';
                        if (message.replyTo) {
                            replyHtml = `
                                <div class="bg-gray-300 p-2 rounded-md mb-2 border-l-4 border-blue-500">
                                    <span class="text-sm font-semibold text-blue-700">${message.replyTo.username}</span>
                                    <p class="text-xs text-gray-600 truncate">${message.replyTo.text}</p>
                                </div>
                            `;
                        }

                        if (isMyMessage) {
                            // æˆ‘å‘é€çš„æ¶ˆæ¯ï¼šåªæ˜¾ç¤ºæ¶ˆæ¯æ°”æ³¡ï¼Œå±…å³å¯¹é½
                            messageElement.className = 'flex flex-col max-w-[80%] self-end';
                            if (message.type === 'check-in') {
                                messageElement.innerHTML = `
                                    <div class="bg-white p-4 rounded-lg shadow-md border">
                                        <p class="text-sm font-semibold text-right">${message.username}</p>
                                        <div class="bg-gray-100 p-2 mt-1 rounded-lg">
                                            <p class="text-gray-800 text-sm">ç­¾åˆ°</p>
                                        </div>
                                        <span class="text-xs text-gray-400 mt-1 block text-right">
                                            ${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString() : '...'}
                                        </span>
                                    </div>
                                `;
                            } else {
                                messageElement.innerHTML = `
                                    <div class="p-3 rounded-xl shadow-md border max-w-full bg-blue-500 text-white cursor-pointer" onclick="showReplyPreview(${JSON.stringify(message).replace(/"/g, '&quot;')})">
                                        <div class="text-sm font-semibold mb-1">
                                            ${message.username}
                                        </div>
                                        ${replyHtml}
                                        <p class="break-words">${message.text}</p>
                                        <span class="text-xs text-gray-200 mt-1 block text-right">
                                            ${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString() : '...'}
                                        </span>
                                    </div>
                                `;
                            }
                        } else {
                            // å…¶ä»–äººå‘é€çš„æ¶ˆæ¯ï¼šæ˜¾ç¤ºå¤´åƒå’Œæ¶ˆæ¯æ°”æ³¡ï¼Œå±…å·¦å¯¹é½
                            messageElement.className = 'flex items-start space-x-2 max-w-[80%]';

                            // åˆ›å»ºä¸€ä¸ªå¯ç‚¹å‡»çš„åŒºåŸŸï¼Œç”¨äºè§¦å‘ç§ä¿¡
                            const avatarAndNameContainer = document.createElement('div');
                            avatarAndNameContainer.className = 'flex flex-col items-center space-y-1 cursor-pointer flex-shrink-0';
                            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢ç‚¹å‡»å¤´åƒæ—¶åŒæ—¶è§¦å‘æ¶ˆæ¯çš„å›å¤åŠŸèƒ½
                            avatarAndNameContainer.addEventListener('click', (e) => {
                                e.stopPropagation();
                                startPrivateChat(message.userId, message.username);
                            });

                            const avatarDiv = document.createElement('div');
                            avatarDiv.className = 'w-8 h-8 rounded-lg flex items-center justify-center bg-gray-300 text-gray-800 font-bold';
                            avatarDiv.textContent = avatarText;

                            const nameSpan = document.createElement('span');
                            nameSpan.className = 'text-xs font-semibold text-gray-700 mt-1';
                            nameSpan.textContent = message.username || 'åŒ¿åç”¨æˆ·';

                            avatarAndNameContainer.appendChild(avatarDiv);
                            avatarAndNameContainer.appendChild(nameSpan);
                            
                            messageElement.appendChild(avatarAndNameContainer);
                            
                            // æ¶ˆæ¯ä¸»ä½“éƒ¨åˆ†
                            const messageBody = document.createElement('div');

                            if (message.type === 'check-in') {
                                messageBody.className = 'bg-white p-4 rounded-lg shadow-md border flex-1';
                                messageBody.innerHTML = `
                                    <p class="text-sm font-semibold">${message.username}</p>
                                    <div class="bg-gray-100 p-2 mt-1 rounded-lg">
                                        <p class="text-gray-800 text-sm">ç­¾åˆ°</p>
                                    </div>
                                    <span class="text-xs text-gray-400 mt-1 block">
                                        ${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString() : '...'}
                                    </span>
                                `;
                            } else {
                                messageBody.className = 'p-3 rounded-xl shadow-md border max-w-full bg-gray-200 text-gray-800 flex-1 cursor-pointer';
                                messageBody.innerHTML = `
                                    ${replyHtml}
                                    <p class="break-words">${message.text}</p>
                                    <span class="text-xs text-gray-500 mt-1 block">
                                        ${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString() : '...'}
                                    </span>
                                `;
                                // ä¸ºæ¶ˆæ¯æ°”æ³¡æœ¬èº«æ·»åŠ å›å¤äº‹ä»¶
                                messageBody.addEventListener('click', () => {
                                    showReplyPreview(message);
                                });
                            }
                            messageElement.appendChild(messageBody);
                        }
                        
                        chatBox.appendChild(messageElement);
                    });
                    chatBox.scrollTop = chatBox.scrollHeight;
                }, (error) => {
                    console.error("Error listening to messages: ", error);
                    displayError(`åŠ è½½æ¶ˆæ¯å¤±è´¥ï¼š${error.message}`);
                });
            }

            function displayError(message) {
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorMessageSpan.textContent = `å‘ç”Ÿäº†é”™è¯¯ï¼š${message}`;
            }
        });
    </script>
</body>
</html><!-- æµ‹è¯• -->

ï¿½
